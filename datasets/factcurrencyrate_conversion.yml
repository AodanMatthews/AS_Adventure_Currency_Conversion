unique_name: factcurrencyrate_conversion
object_type: dataset
label: factcurrencyrate_conversion
columns:
  - name: PRODUCTKEY
    data_type: decimal(38,0)
  - name: SALESTERRITORYKEY
    data_type: decimal(38,0)
  - name: CURRENCYKEY_FROM
    data_type: decimal(38,0)
  - name: CURRENCYKEY_TO
    data_type: decimal(38,0)
  - name: DATEKEY
    data_type: decimal(38,0)
  - name: RATES
    data_type: double
  - name: RATETYPE
    data_type: string
connection_id: As_Adventure
sql: |-
  WITH CurrencyRates AS
  (
  SELECT 
  curFrom."currencykey" as currencykey_from,
  curTo."currencykey" as currencykey_to,
  curFrom."datekey" as datekey,
  curFrom."averagerate" / curTo."averagerate" as actualrate,
  (curFrom."endofdayrate" / curTo."endofdayrate") * 1.1 as budgetedrate

  FROM
  SE_DEMO_LIBRARY.AS_ADVENTURE_SMALL."factcurrencyrate"  curFrom
  JOIN SE_DEMO_LIBRARY.AS_ADVENTURE_SMALL."factcurrencyrate"  curTo
  ON curTo."datekey" = curfrom."datekey"
  WHERE
  curfrom."currencykey" in (6, 19, 29, 39, 98, 100) and
  curto."currencykey" in (36, 98, 100)
  ),

  JoiningKeys AS
  (
  SELECT
  "productkey" as productkey,
  "currencykey",
  "salesterritorykey" as salesterritorykey,
  "orderdatekey"
  FROM
  SE_DEMO_LIBRARY.AS_ADVENTURE_SMALL."factinternetsales"
  GROUP BY
  "productkey",
  "currencykey",
  "salesterritorykey",
  "orderdatekey"
  ),

  RatesTable AS 
  (
  SELECT
  productkey,
  salesterritorykey,
  currencykey_from,
  currencykey_to,
  CurrencyRates.datekey,
  actualrate,
  budgetedrate
  FROM
  CurrencyRates
  JOIN JoiningKeys 
  ON CurrencyRates.currencykey_from = JoiningKeys."currencykey"
  AND CurrencyRates.datekey = JoiningKeys."orderdatekey"
  )

  SELECT
  productkey,
  salesterritorykey,
  currencykey_from,
  currencykey_to,
  datekey,
  rates,
  ratetype
  FROM
  RatesTable
  UNPIVOT 
  (
  rates FOR ratetype IN (actualrate, budgetedrate)
  )
